<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" type="text/css" href="draw.css">
  <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    function downloadCanvas() {
      var dlLink = document.createElement('a');
      var aikanyt = new Date();
      var aikastring = aikanyt.getFullYear()+"-"+(addz(aikanyt.getMonth()+1))+"-"+addz(aikanyt.getDate());
      dlLink.download = "karvoitus-"+aikastring+".png";
      dlLink.href = document.getElementById('drawzone').toDataURL('image/png');
      document.body.appendChild(dlLink);
      dlLink.click();
      document.body.removeChild(dlLink);
    }
  </script>
  <title>Karvoituspeli</title>
</head>
<body onresize="set_offsets()">

<div id="left">
  <div id="drawframe" onmousedown="klik(event)" onmouseup="deklik(event)">
    <canvas id="drawzone" width="800" height="450">
    If you see this text HTML5 Canvas is not supported by your browser.
    </canvas>
    <div id="piirtoaika" class="unselectable"></div>
  </div>

  <div id="tools" class="unselectable">
  <form name="Show">
    <div class="tools_sarake">
      Tools:<br>
      <input type="radio" name="tool" value="freedraw" checked> Free draw<br>
      <input type="radio" name="tool" value="line"> Line<br>
      <input type="radio" name="tool" value="circle"> Circle<br>
      <input type="radio" name="tool" value="oval"> Oval<br>
      <input type="radio" name="tool" value="rect"> Rectangle<br>
    </div>
    <div class="tools_sarake">
      <style scoped>
          .button-xsmall {
              font-size: 70%;
          }
      </style>
      <input type="button" value="Undo" onclick="socket.emit('command', 'undo')">
      <input type="button" value="Clear" onclick="socket.emit('command', 'clear')">
      <input type="button" value="Save image" onclick="downloadCanvas()"><br>
      <input type="checkbox" name="Mid" value="true"> Start shape from center<br>
      <input type="checkbox" name="Fill" value="true"> Fill<br>
      Line width<br>
      <input type="range" name="Width" style="cursor: pointer" value=1 min=1 max=80><br>
      Alpha<br>
      <input type="range" name="Alpha" style="cursor: pointer" value=1 step=0.05 min=0 max=1>
    </div>
    <div class="tools_sarake">
      <div id="vval-div"><input type="color" id="vval" name="Color" value="#000000"></div>
      <input type="button" class="vnap" value=" " style="margin-left:78px;background:#000000;" onclick="vaihda_vari('#000000')">
      <input type="button" class="vnap" value=" " style="background:#808080;" onclick="vaihda_vari('#808080')">
      <input type="button" class="vnap" value=" " style="background:#C0C0C0;" onclick="vaihda_vari('#C0C0C0')">
      <input type="button" class="vnap" value=" " style="background:#FFFFFF;" onclick="vaihda_vari('#FFFFFF')"><br>
      <input type="button" class="vnap" value=" " style="background:#FF0000;" onclick="vaihda_vari('#FF0000')">
      <input type="button" class="vnap" value=" " style="background:#FFFF00;" onclick="vaihda_vari('#FFFF00')">
      <input type="button" class="vnap" value=" " style="background:#00FF00;" onclick="vaihda_vari('#00FF00')">
      <input type="button" class="vnap" value=" " style="background:#00FFFF;" onclick="vaihda_vari('#00FFFF')">
      <input type="button" class="vnap" value=" " style="background:#0000FF;" onclick="vaihda_vari('#0000FF')">
      <input type="button" class="vnap" value=" " style="background:#FF00FF;" onclick="vaihda_vari('#FF00FF')"><br>
      <input type="button" class="vnap" value=" " style="background:#880000;" onclick="vaihda_vari('#880000')">
      <input type="button" class="vnap" value=" " style="background:#777700;" onclick="vaihda_vari('#777700')">
      <input type="button" class="vnap" value=" " style="background:#006600;" onclick="vaihda_vari('#006600')">
      <input type="button" class="vnap" value=" " style="background:#007777;" onclick="vaihda_vari('#007777')">
      <input type="button" class="vnap" value=" " style="background:#000088;" onclick="vaihda_vari('#000088')">
      <input type="button" class="vnap" value=" " style="background:#880088;" onclick="vaihda_vari('#880088')"><br>
      <input type="button" class="vnap" value=" " style="background:#FF80AA;" onclick="vaihda_vari('#FF80AA')">
      <input type="button" class="vnap" value=" " style="background:#FF8C1A;" onclick="vaihda_vari('#FF8C1A')">
      <input type="button" class="vnap" value=" " style="background:#663300;" onclick="vaihda_vari('#663300')">
      <input type="button" class="vnap" value=" " style="background:#FFD9B3;" onclick="vaihda_vari('#FFD9B3')">
      <input type="button" class="vnap" value=" " style="background:#111111;" onclick="vaihda_vari('#111111')">
      <input type="button" class="vnap" value=" " style="background:#CC33FF;" onclick="vaihda_vari('#CC33FF')"><br>
    </div>
    <div id="koords">
      X: <input type="text" name="MouseX" value="0" size="4"><br>
      Y: <input type="text" name="MouseY" value="0" size="4"><br>
    </div>
  </form>
  </div>
  <div id="userlist">
    Userlist
    <table id="users" style="width:100%">
    </table>
  </div>
</div>

<div id="right">
  <ul id="messages" tabindex="1"></ul>
  <form id="chatti">
    <input type="text" id="nick" value="anon"><input id="msg" autocomplete="off" /><button id="chatsend">Send</button>
  </form>
</div>

<script src="draw.js"></script>

<script>
  var tools = document.getElementById("tools").innerHTML;
  var timestamps = false;
  var sekunnit;
  var piirtoaikalaskuri;
  var is_chrome = navigator.userAgent.toLowerCase().indexOf('chrome') > -1;

  function piirtovuoroon() {
    document.getElementById("tools").innerHTML = tools;
    document.onmousemove = getMouseXY;
    document.getElementById("drawframe").onmousedown = klik;
    document.getElementById("drawframe").onmouseup = deklik;
  }

  function piirtovuorosta() {
    document.onmousemove = "";
    document.getElementById("drawframe").onmousedown = "";
    document.getElementById("drawframe").onmouseup = "";
    document.getElementById("tools").innerHTML = "";
  }

  function toggle_timestamp() {
    if (timestamps) {
      timestamps = false;
    }
    else {
      timestamps = true;
    }
  }

  function addz(x) {
    if (x < 10) {
      return "0"+x;
    }
    return x;
  }

  function timestamp() {
    var d = new Date();
    var timestring = addz(d.getHours())+":"+addz(d.getMinutes())+":"+addz(d.getSeconds());
    return "["+timestring+"] ";
  }

  function piirtoaika_tick() {
    sekunnit = sekunnit-1;
    var mins = Math.floor(sekunnit/60);
    var seks = addz(sekunnit%60);
    $('#piirtoaika').html(mins+":"+seks);
    piirtoaikalaskuri = setTimeout(piirtoaika_tick, 1000);
  }

  piirtovuoroon();
  if (!is_chrome) {$('#messages').append($('<li>').text("** Chromium-based web browser such as Google Chrome is recommended for playing this game"));}

  var socket = io();
  $('#nick').change(function(){
    socket.emit('command', "nick "+$('#nick').val());
  });
  $('form').submit(function(){
    var msg_val = $('#msg').val()
    if (msg_val[0] == '/') {
      if (msg_val.slice(1) == "timestamp") {
        toggle_timestamp();
      }
      else {
        socket.emit('command', msg_val.slice(1));
      }
    }
    else {
      socket.emit('chat message', msg_val );
    }
    $('#msg').val('');
    return false;
  });
  socket.on('message', function(msg){
    if (timestamps) {
      msg = timestamp()+msg;
    }
    $('#messages').append($('<li>').text(msg));
    $('#messages').scrollTop($('#messages')[0].scrollHeight);
  });
  socket.on('nick', function(newnick){
    $('#nick').val(newnick);
  });
  socket.on('muodot', function(muod){
    muodot = muod;
    refrsh();
  });
  socket.on('draw', function(asdfg){
    if (asdfg) {
      piirtovuoroon();
    }
    else {
      piirtovuorosta();
    }
  });
  socket.on('drawtime', function(draw_t){
    if (draw_t != "") {
      sekunnit = draw_t+1;
      piirtoaika_tick();
    }
    else {
      clearTimeout(piirtoaikalaskuri);
      $('#piirtoaika').html("");
    }
  });
  socket.on('users', function(userlista){
    $('#users tbody tr').remove();
    for (var i = 0; i < userlista.length; i++) {
      var row = document.getElementById('users').insertRow(0);
      row.insertCell(0).innerHTML = userlista[i][0];
      row.insertCell(1).innerHTML = userlista[i][1];
    }
  })
</script>

</body>
</html>